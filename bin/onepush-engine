#!/usr/bin/env ruby
require 'optparse'

ROOT = File.absolute_path(File.dirname(__FILE__) + "/..")
PWD  = Dir.pwd
ENV['BUNDLE_GEMFILE'] = "#{ROOT}/Gemfile"
STDOUT.sync = STDERR.sync = true

require 'bundler/setup'
require 'json'

command = ARGV[0]
ARGV.shift

ENV.delete('MANIFEST_JSON')
ENV.delete('SSHKIT_OUTPUT')
ENV.delete('INSTALL_PUBKEYS')
ENV.delete('SSH_KEYS')
ENV.delete('VAGRANT_KEY')
ENV.delete('SERVERS')
ENV.delete('REPORT_PROGRESS')
ENV.delete('PROGRESS_BASE')
ENV.delete('PROGRESS_CEIL')

case command
when "setup", "deploy"
  setup_addresses = []
  deploy_addresses = []
  ssh_keys = []

  parser = OptionParser.new do |opts|
    opts.banner = "Usage: onepush-engine #{command} [options]"
    opts.separator ""

    opts.separator "Options:"
    opts.on("--manifest FILENAME", String) do |filename|
      ENV['MANIFEST_JSON'] = File.read(filename)
    end
    opts.on("--manifest-json JSON", String) do |json|
      ENV['MANIFEST_JSON'] = json
    end
    opts.on("--setup-address ADDRESS", String) do |address|
      setup_addresses << address
    end
    if command == "deploy"
      opts.on("--deploy-address ADDRESS", String) do |address|
        deploy_addresses << address
      end
    end
    opts.on("--ssh-log FILENAME", String) do |filename|
      ENV['SSHKIT_OUTPUT'] = filename
    end
    opts.on("--ssh-key FILENAME", String, "Private key to use for SSH connection") do |filename|
      ssh_keys << filename
    end
    opts.on("--vagrant-key", "Use Vagrant insecure private key for SSH connection") do
      ENV['VAGRANT_KEY'] = '1'
    end
    opts.on("--progress") do
      ENV['REPORT_PROGRESS'] = '1'
    end
    opts.on("--progress-base NUMBER", Float) do |val|
      ENV['PROGRESS_BASE'] = val.to_s
    end
    opts.on("--help") do
      puts parser
      exit
    end
  end
  begin
    parser.parse!
  rescue OptionParser::ParseError => e
    STDERR.puts e
    STDERR.puts
    STDERR.puts "Please see '--help' for valid options."
    exit 1
  end

  if setup_addresses.empty?
    abort "Please specify at least one --setup-address."
  end
  if command == "deploy" && deploy_addresses.empty?
    abort "Please specify at least one --deploy-address."
  end

  ENV['SETUP_ADDRESSES'] = JSON.generate(setup_addresses)
  if command == "deploy"
    ENV['DEPLOY_ADDRESSES'] = JSON.generate(deploy_addresses)
  end
  ENV['SSH_KEYS'] = JSON.generate(ssh_keys)
  ENV['APP_ROOT'] = PWD
  if command == "setup"
    Dir.chdir("#{ROOT}/setup")
    exec("bundle", "exec", "cap", "production", "setup")
  else
    Dir.chdir("#{ROOT}/deploy_ruby")
    exec("bundle", "exec", "cap", "production", "deploy")
  end

else
  puts "Usage: onepush <setup|deploy> [options...]"
  puts
  puts "Type onepush <COMMAND> --help for more information."
  exit 1
end
